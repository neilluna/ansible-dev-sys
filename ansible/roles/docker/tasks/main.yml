---
- name: Preparing to merge the variables ...
  set_fact:
    default_var__to_merge: '{{ docker_defaults | default({}) }}'
    new_var__to_merge: '{{ docker | default({}) }}'

- name: Merging the variables ...
  merge_vars:
    expected_type: dict
    merged_var_name: merged_var
    recursive_dict_merge: yes
    suffix_to_merge: var__to_merge

- name: Saving the merged variables ...
  set_fact:
    docker: '{{ merged_var }}'

- name: Adding the apt key ...
  apt_key:
    url: https://download.docker.com/linux/ubuntu/gpg
  become: yes

- name: Adding the apt repository ...
  apt_repository:
    repo: deb [arch=amd64] https://download.docker.com/linux/ubuntu bionic stable
  become: yes

- name: Running apt update ...
  apt:
    force_apt_get: yes
    update_cache: yes
  become: yes

- name: Installing or updating ...
  apt:
    name: docker-ce
    force_apt_get: yes
    state: latest
  become: yes

- name: Ensuring the service is started and enabled at boot ...
  service:
    name: docker
    state: started
    enabled: yes
  become: yes

- name: Adding users to the Docker group ...
  user:
    name: '{{ item }}'
    groups:
    - docker
    append: yes
  with_items: '{{ docker.users }}'
  become: yes

- name: Marking the role as executed ...
  set_fact:
    roles_already_executed: "{{ roles_already_executed }} + [ '{{ role_name }}' ]"
