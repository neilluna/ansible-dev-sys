---
- name: Preparing to merge the variables ...
  set_fact:
    default_var__to_merge: '{{ nodejs_defaults | default({}) }}'
    new_var__to_merge: '{{ nodejs | default({}) }}'

- name: Merging the variables ...
  merge_vars:
    expected_type: dict
    merged_var_name: merged_var
    recursive_dict_merge: yes
    suffix_to_merge: var__to_merge

- name: Saving the merged variables ...
  set_fact:
    nodejs: '{{ merged_var }}'

- name: Installing ...
  shell: bash -c "source ~/.nvm/nvm.sh && nvm install {{ nodejs.version }}"
  register: nvm_installation
  changed_when: "'is already installed.' not in nvm_installation.stderr"

- name: Checking the default version ...
  shell: bash -c "source ~/.nvm/nvm.sh && nvm ls --no-colors | grep -e 'default -> {{ nodejs.version }}'"
  register: nvm_check_for_correct_version
  changed_when: False
  failed_when: False

- name: Setting the default version ...
  shell: bash -c "source ~/.nvm/nvm.sh && nvm alias default {{ nodejs.version }}"
  when: nvm_check_for_correct_version.rc != 0
